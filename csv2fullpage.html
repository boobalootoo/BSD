<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Brighton Services Directory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .subcategory-container { display: none; }
    .subcategory-container.active { display: grid; }
    #map { height: 400px; margin-top: 20px; border-radius: 12px; }
    .cat-active { outline: 3px solid rgba(59,130,246,.6); }
  </style>
</head>
<body class="flex flex-col min-h-screen">
  <!-- Header -->
  <header class="bg-white sticky top-0 z-50 shadow-sm p-4 flex items-center justify-between">
    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
      <i class="fa-solid fa-hand-holding-heart text-blue-600 mr-2"></i>
      Brighton Services Directory
    </h1>
    <a href="tel:999" class="bg-red-600 text-white rounded-full p-3 md:p-4 text-xl font-bold uppercase shadow-lg hover:bg-red-700 transition-colors duration-200" aria-label="Emergency Services 999">
      999
    </a>
  </header>

  <!-- Main -->
  <main class="flex-1 p-4 pb-24 md:p-6">
    <div class="max-w-4xl mx-auto">
      <!-- Filters -->
      <section class="mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Filters</h2>
        <div id="filter-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
      </section>

      <!-- Categories -->
      <section class="mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Categories</h2>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 md:gap-6">
          <button class="category-btn bg-white rounded-xl shadow-md p-4 text-center hover:scale-105 transition" data-category="Health">
            <i class="fa-solid fa-heart-pulse text-4xl text-red-500 mb-2"></i>
            <span class="block font-medium">Health</span>
          </button>
          <button class="category-btn bg-white rounded-xl shadow-md p-4 text-center hover:scale-105 transition" data-category="Food">
            <i class="fa-solid fa-bread-slice text-4xl text-orange-500 mb-2"></i>
            <span class="block font-medium">Food</span>
          </button>
          <button class="category-btn bg-white rounded-xl shadow-md p-4 text-center hover:scale-105 transition" data-category="Accommodation">
            <i class="fa-solid fa-house-chimney text-4xl text-purple-500 mb-2"></i>
            <span class="block font-medium">Accommodation</span>
          </button>
          <button class="category-btn bg-white rounded-xl shadow-md p-4 text-center hover:scale-105 transition" data-category="Help into Work">
            <i class="fa-solid fa-briefcase text-4xl text-green-500 mb-2"></i>
            <span class="block font-medium">Help into Work</span>
          </button>
        </div>

        <!-- Example Subcategories -->
        <div id="subcategories-Health" class="subcategory-container grid-cols-2 gap-4 mt-4">
          <button class="subcategory-btn bg-white rounded-xl shadow p-4 text-center" data-subcategory="Physical Health">
            <i class="fa-solid fa-person text-3xl text-red-500 mb-2"></i>
            <span>Physical Health</span>
          </button>
          <button class="subcategory-btn bg-white rounded-xl shadow p-4 text-center" data-subcategory="Mental Health">
            <i class="fa-solid fa-brain text-3xl text-red-500 mb-2"></i>
            <span>Mental Health</span>
          </button>
        </div>
      </section>

      <!-- Services -->
      <section>
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Services</h2>
        <div id="services-list" class="space-y-4"></div>
        <div id="no-services" class="hidden text-center text-gray-500 mt-8">
          <i class="fa-solid fa-face-sad-cry text-4xl mb-2"></i>
          <p class="text-lg font-medium">No services match your criteria.</p>
        </div>
      </section>

      <!-- Map -->
      <section>
        <h2 class="text-lg font-semibold text-gray-700 mt-6 mb-2">Map</h2>
        <div id="map"></div>
      </section>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const csvUrl = "https://raw.githubusercontent.com/boobalootoo/BSD/main/info.csv";

      // Example filters
      const filters = ["Men","Women","Children","Families","LGBTQ","Housed","Unhoused"];

      const filterContainer = document.getElementById("filter-container");
      const servicesList = document.getElementById("services-list");
      const noServicesMessage = document.getElementById("no-services");

      let services = []; // will be loaded from CSV
      let activeFilters = new Set();
      let activeCategory = null;
      let activeSubcategory = null;

      // Map
      const map = L.map("map").setView([50.828, -0.14], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);
      let markers = [];

      async function fetchCsv(url) {
        const resp = await fetch(url);
        return await resp.text();
      }

      function parseCsv(raw) {
        const lines = raw.split(/\r?\n/).filter(l => l.trim());
        return lines.slice(1).map(line => line.split(","));
      }

      async function geocode(address) {
        const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(address);
        const resp = await fetch(url);
        const data = await resp.json();
        return data[0] ? { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) } : null;
      }

      async function loadServices() {
        const raw = await fetchCsv(csvUrl);
        const rows = parseCsv(raw);

        for (let row of rows) {
          let num = row[1], street = row[2], postcode = row[3];
          if (!num || !street || !postcode) continue;
          let addr = `${num} ${street}, ${postcode}, UK`;
          let coords = await geocode(addr);
          if (!coords) continue;

          services.push({
            id: services.length + 1,
            category: "Health", // you can map real categories from CSV if present
            subCategory: "General",
            title: addr,
            description: "Service located at " + addr,
            contact: "N/A",
            filters: ["All"],
            lat: coords.lat,
            lng: coords.lng,
            icon: "fa-solid fa-location-dot"
          });

          await new Promise(r => setTimeout(r, 1000)); // throttle API
        }

        renderServices();
      }

      function updateMap(filtered) {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        filtered.forEach(s => {
          const marker = L.marker([s.lat, s.lng])
            .bindPopup(`<strong>${s.title}</strong><br>${s.description}`)
            .addTo(map);
          markers.push(marker);
        });
        if (filtered.length > 0) {
          const group = L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.3));
        }
      }

      function renderServices() {
        const filtered = services.filter(s => {
          if (activeCategory && s.category !== activeCategory) return false;
          if (activeSubcategory && s.subCategory !== activeSubcategory) return false;
          if (activeFilters.size > 0) {
            return [...activeFilters].some(f => s.filters.includes(f)) || s.filters.includes("All");
          }
          return true;
        });

        servicesList.innerHTML = "";
        if (filtered.length === 0) {
          noServicesMessage.classList.remove("hidden");
        } else {
          noServicesMessage.classList.add("hidden");
          filtered.forEach(s => {
            const card = document.createElement("div");
            card.className = "bg-white rounded-xl shadow p-4";
            card.innerHTML = `<h3 class="font-bold">${s.title}</h3><p>${s.description}</p>`;
            servicesList.appendChild(card);
          });
        }

        updateMap(filtered);
      }

      // Filters
      filters.forEach(f => {
        const label = document.createElement("label");
        label.className = "flex items-center gap-2 bg-white p-2 rounded shadow cursor-pointer";
        const input = document.createElement("input");
        input.type = "checkbox"; input.value = f;
        input.addEventListener("change", () => {
          if (input.checked) activeFilters.add(f); else activeFilters.delete(f);
          renderServices();
        });
        label.appendChild(input); label.appendChild(document.createTextNode(f));
        filterContainer.appendChild(label);
      });

      loadServices();
    });
  </script>
</body>
</html>
